<!DOCTYPE html>
<head>
    <title>Player Registration</title>
</head>
<body>
    <label>Players: </label>
    <ul id="lbPlayers"></ul>
    <br/>
    <br/>

    <label id="lblID">Team ID: </label>
    <br/>
    <label>Player Name: </label>
    <input type="text" id="tbName"/>
    <br/>
    <button id="btnSubmit">Insert Player</button>
    <button id="btnDelete">Delete Player</button>
    <br/>
    <button id="btnFinish">Submit & Play</button>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script type="text/javascript">
        $(document).ready(function() {
            const ajaxUrl = "http://localhost:8080/api/players";
            const gotoUrlTeam = "http://localhost:8080/dashboard.html";
            const gotoUrlWait = "http://localhost:8080/wait.html";
            
            const teamid = localStorage.getItem("teamid"); 

            var selectedPlayer = "";

            $("#btnSubmit").click(function() {
                document.getElementById("btnSubmit").disabled = true;
                var name = document.getElementById("tbName").value;

                $.ajax({
                    type: "PUT",
                    url: ajaxUrl,
                    data: '{"ID":' + teamid + ', "Player": "' + name +'", "Active": 1}',
         
                    contentType: "application/json"
                }).done(function(result) {
                    if (result.recordset[0]["player_id"] != 0) {
                        
                        $.ajax({
                            type: "POST",
                            url: ajaxUrl,
                            data: '{"ID":' + teamid + '}',
                            contentType: "application/json"
                        }).done(function(result) {
                            if (result.recordsets.length != 0) {
                                for (var i = 0; i < result.recordset.length; i++) {
                                    var list = document.getElementById("lbPlayers");
                                    var listitem = document.createElement("li");
                                    var listlink = document.createElement("a");
                                    listlink.textContent = result.recordset[i]["player_name"];
                                    listlink.setAttribute("href", "javascript:;");
                                    listlink.setAttribute("ID", i);

                                    listitem.appendChild(listlink);

                                    var existing = list.getElementsByTagName("li");
                                    
                                    var match = false;
                                    for (var x = 0; x < existing.length; x++) {
                                        if (existing[x].innerHTML === listitem.innerHTML) {
                                            match = true;
                                            break;
                                        }
                                    }

                                    if (!match) {
                                        list.appendChild(listitem);
                                    }
                                }
                            }
                        })
                        
                        document.getElementById("btnSubmit").disabled = false;
                    }
                    else {
                        alert("Player insert failure");
                        document.getElementById("btnSubmit").disabled = false;
                    }
                });
            });

            $("#btnDelete").click(function() {
                document.getElementById("btnDelete").disabled = true;

                var name = document.getElementById("tbName").value;

                $.ajax({
                    type: "PUT",
                    url: ajaxUrl,
                    data: '{"ID":' + teamid + ', "Player": "' + name +'", "Active": 0}',
         
                    contentType: "application/json"
                }).done(function(result) {
                    if (result.recordset[0]["player_id"] != 0) {
                        
                        $.ajax({
                            type: "POST",
                            url: ajaxUrl,
                            data: '{"ID":' + teamid + '}',
                            contentType: "application/json"
                        }).done(function(result) {
                            if (result.recordsets.length != 0) {
                                $("#lbPlayers").empty();
                                for (var i = 0; i < result.recordset.length; i++) {
                                    var list = document.getElementById("lbPlayers");
                                    var listitem = document.createElement("li");
                                    var listlink = document.createElement("a");
                                    listlink.textContent = result.recordset[i]["player_name"];
                                    listlink.setAttribute("href", "javascript:;");
                                    listlink.setAttribute("ID", i);

                                    listitem.appendChild(listlink);

                                    var existing = list.getElementsByTagName("li");
                                    
                                    var match = false;
                                    for (var x = 0; x < existing.length; x++) {
                                        if (existing[x].innerHTML === listitem.innerHTML) {
                                            match = true;
                                            break;
                                        }
                                    }

                                    if (!match) {
                                        list.appendChild(listitem);
                                    }
                                }
                            }
                        })
                        document.getElementById("btnDelete").disabled = false;
                    }
                    else {
                        alert("Player insert failure");
                        document.getElementById("btnDelete").disabled = false;
                    }
                });
            });

            $("#btnFinish").click(function() {
                $.ajax({
                    type: "GET",
                    url: ajaxUrlEvent,
                    async: false
                }).done(function(result2) {
                    if (result2.recordset[0]["event_id"] > 0) {
                        var today = new Date();
                        var sDate = new Date(result2.recordset[0]["start_date"].replace("Z", ""));
                        var sTime = new Date(result2.recordset[0]["start_time"].replace("Z", ""));
                        var eDate = new Date(result2.recordset[0]["end_date"].replace("Z",""));
                        var eTime = new Date(result2.recordset[0]["end_time"].replace("Z",""));

                        sDate.setHours(sTime.getHours());
                        sDate.setMinutes(sTime.getMinutes());
                        sDate.setSeconds(sTime.getSeconds());
                        eDate.setHours(eTime.getHours());
                        eDate.setMinutes(eTime.getMinutes());
                        eDate.setSeconds(eTime.getSeconds());

                        //localStorage.setItem("teamid", result.recordset[0]["id"]);
                        localStorage.setItem("eventid", result2.recordset[0]["event_id"]);

                        if (today >= sDate &&
                            today <= eDate) {
                            
                            //gotoUrlTeam += result.recordset[0]["id"] + "&event=" + result2.recordset[0]["event_id"];
                            window.location.replace(gotoUrlTeam);
                        }
                        else {
                            //gotoUrlWait += result.recordset[0]["id"];
                            window.location.replace(gotoUrlWait);
                        }
                    }
                })
            });

            document.querySelector("body").addEventListener("click", function(e) {
                var anchor = e.target.closest('a');
                if (anchor !== null) {
                    selectedPlayer = anchor.textContent;
                    document.getElementById("tbName").value = anchor.textContent;
                }
            });
        });
        
    </script>
</body>