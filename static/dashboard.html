<!doctype html>
<html lang="en">
    <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Team Dashboard</title>
    <link rel="stylesheet" href="http://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <script src="https://code.jquery.com/jquery-1.12.4.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <link rel="stylesheet" href="./css styles/splash-style.css">
    <link rel="stylesheet" href="./css styles/side-nav.css">
    <link rel="stylesheet" href="./css styles/dashboard.css">
    <script>
    //https://api.jqueryui.com/dialog/
    // $( "#dialog" ).dialog({
    //     dialogClass: "no-close",
    //     buttons: [
    //         {
    //         text: "OK",
    //         click: function() {
    //             $( this ).dialog( "close" );
    //         }
    //         }
    //     ]
    //     });
    // $( function() {
    //     $( "#dialog" ).dialog();
    // } );
    // $( function() {
    //     $( "#dialog2" ).dialog();
    // } );
    </script>
    </head>
    <body>
        <div id="horinav" style="float: right;">
            <label class="hacker">Current Score:</label>
            <label class="hacker" id="currentscore">0</label>
        </div>
        <div class="sidenav" id="navbar">
            <label class="hacker"><b>Questions</b></label>
        </div>
        <div id="main">

        </div>
        <script>
            var team = false;
            var eventid = sessionStorage.getItem("eventid");
            var teamid = sessionStorage.getItem("teamid");

            const ajaxUrlQuestions = "http://localhost:8080/api/eventquestions";
            const ajaxUrlAnswers = "http://localhost:8080/api/submitanswer";
            const ajaxUrlHints = "http://localhost:8080/api/gethint";

            $(document).ready(function() {

                if (eventid != null && teamid != null) {
                    team = true;
                }


                // (function poll(){
                // setTimeout(function(){
                //     $.ajax({ url: "server", success: function(data){
                //         //Update your dashboard gauge
                //         salesGauge.setValue(data.value);
                //         //Setup the next poll recursively
                //         poll();
                //     }, dataType: "json"});
                // }, 30000);
                // })();

                $.ajax({
                    type: "POST",
                    url: ajaxUrlQuestions,
                    data: '{"Event": "' + eventid + '"}',
                    contentType: "application/json"
                }).done(function(result) {
                    if (result.recordset.length > 0) {
                        for (var i = 0; i < result.recordset.length; i++) {
                            var nav = document.getElementById("navbar");
                            var link = document.createElement("a");
                            link.setAttribute("href", "javascript:;");

                            var span = document.createElement("span");
                            span.setAttribute("id", "question" + result.recordset[i]["question_id"]);
                            span.textContent = "Question " + (i + 1);
                            span.setAttribute("class", "hacker");
                            link.appendChild(span);
                            nav.appendChild(link);

                            var main = document.getElementById("main");

                            var newDialog = document.createElement("div");
                            newDialog.setAttribute("id", "dialog" + result.recordset[i]["question_id"]);
                            newDialog.setAttribute("class", "no-close");
                            newDialog.setAttribute("title", "Question " + (i + 1));

                            var br = document.createElement("br");

                            var para = document.createElement("p");
                            para.setAttribute("id", "question" + result.recordset[i]["question_id"]);
                            para.textContent = result.recordset[i]["question"];
                            para.style.padding = "0px 10px 10px 10px";

                            var area = document.createElement("input");
                            area.setAttribute("id", "answer" + result.recordset[i]["question_id"]);
                            area.setAttribute("resizable", true);
                            area.style.padding = "0px 10px 10px 10px";
                            
                            var subButton = document.createElement("button");
                            subButton.setAttribute("id", "submit" + result.recordset[i]["question_id"]);
                            subButton.textContent = "Submit";
                            subButton.style.margin = "0px 10px 10px 10px";

                            var hintButton = document.createElement("button");
                            hintButton.setAttribute("id", "hint" + result.recordset[i]["question_id"]);
                            hintButton.textContent = "See Hint";
                            hintButton.style.margin = "10px";

                            var attach = document.createElement("a");
                            attach.setAttribute("id", "file" + result.recordset[i]["question_id"]);
                            attach.style.padding = "0px 10px 10px 10px";
                            if (result.recordset[i]["filename"].toString() === "") {
                                attach.style.display = "none";
                            }
                            else {
                                attach.textContent = result.recordset[i]["filename"];
                                attach.setAttribute("href", result.recordset[i]["filepath"]);
                                var splitter = result.recordset[i]["filepath"].split("\\");
                                //attach.setAttribute("href", "127.0.0.1:8887/" + splitter[splitter.length - 1]);
                            }

                            var hint = document.createElement("p");
                            hint.setAttribute("id", "hintvalue" + result.recordset[i]["question_id"]);
                            hint.style.padding = "0px 10px 10px 10px";
                            hint.style.display = "none";

                            newDialog.appendChild(para);
                            newDialog.appendChild(br);
                            newDialog.appendChild(area);
                            newDialog.appendChild(br);
                            newDialog.appendChild(subButton);
                            newDialog.appendChild(hintButton);
                            newDialog.appendChild(attach);
                            newDialog.appendChild(hint);
                            main.appendChild(newDialog);

                            $( function() {
                                $("#" + newDialog.id).dialog();
                                $("#" + newDialog.id).dialog("close");
                            } );
                        }
                    }
                })
            });

            $(document).on('click', function(event) {
                var tag = event.target.tagName;

                if (event.target.tagName === "SPAN") {
                    var splitter = event.target.id.split("question")[1];

                    var isOpen = $("#dialog" + splitter).dialog('isOpen');
                    if (!isOpen) {
                        $("#dialog" + splitter).dialog('open');
                    }
                    else {
                        $("#dialog" + splitter).dialog('close');
                    }
                }

                if (team) {
                    if (event.target.tagName === "BUTTON") {
                        if (event.target.id.includes("submit")) {
                            var splitter = event.target.id.split("submit")[1];
                            var answer = $("#answer" + splitter).val();
                            var id = "question" + splitter;

                            $.ajax({
                                type: "POST",
                                url: ajaxUrlAnswers,
                                data: '{"EventID": "'+ eventid + '", "TeamID": "' + teamid + '", "QuestionID": "' + splitter + '", "Answer": "' + answer + '"}',
                                contentType: "application/json"
                            }).done(function(result) {
                                if (result.recordset[0]["solved"] == 3) {
                                    alert("Already solved by another team.");
                                    if (!$("#question" + splitter).val().includes("✗")) {
                                        $("#question" + splitter).val($("#question" + splitter).val() + " ✗");
                                    }
                                    $("#dialog" + splitter).dialog('close');
                                    document.getElementById(id).style.pointerEvents = "none";
                                }
                                else if (result.recordset[0]["solved"] == 2) {
                                    alert("Already solved by your team.");
                                    if (!$("#question" + splitter).val().includes("✓")) {
                                        $("#question" + splitter).val($("#question" + splitter).val() + " ✓");
                                    }
                                    $("#dialog" + splitter).dialog('close');
                                    document.getElementById(id).style.pointerEvents = "none";
                                }
                                else if (result.recordset[0]["solved"] == 0) {
                                    alert("Incorrect");
                                }
                                else {
                                    alert("Correct");
                                    if (!$("#question" + splitter).val().includes("✓")) {
                                        document.getElementById(id).textContent = document.getElementById(id).textContent + " ✓";
                                    }
                                    $("#dialog" + splitter).dialog('close');
                                    document.getElementById(id).style.pointerEvents = "none";

                                    var current = document.getElementById("currentscore").textContent;
                                    var score = parseInt(current);
                                    var value = parseInt(result.recordset[0]["value"]);

                                    document.getElementById("currentscore").textContent = (score + value);
                                }
                            })
                        }
                        else if (event.target.id.includes("hint")) {
                            var splitter = event.target.id.split("hint")[1];

                            $.ajax({
                                type: "POST",
                                url: ajaxUrlHints,
                                data: '{"EventID": "' + eventid + '", "TeamID": "' + teamid + '", "QuestionID": "' + splitter + '"}',
                                contentType: "application/json"
                            }).done(function(result) {
                                if (result.recordset[0]["value"] != 0) {
                                    document.getElementById("hintvalue" + splitter).innerHTML += result.recordset[0]["hint"] + "<br/>";    
                                    document.getElementById("hintvalue" + splitter).style.display = "block";
                                    var current = document.getElementById("currentscore").textContent;
                                    var score = parseInt(current);
                                    var value = parseInt(result.recordset[0]["value"]);

                                    document.getElementById("currentscore").textContent = (score - value);
                                }
                                else if (result.recordset[0]["hint"] === "used") {
                                    $("#" + event.target.id).attr("disabled", true);
                                    document.getElementById("hintvalue" + splitter).innerHTML += "All hints used.<br/>";    
                                    document.getElementById("hintvalue" + splitter).style.display = "block";
                                }
                                else {
                                    document.getElementById("hintvalue" + splitter).innerHTML += "Not enough points<br/>";    
                                    document.getElementById("hintvalue" + splitter).style.display = "block";
                                }
                            })
                        }
                    }
                }
            });
        </script>
    </body>
</html>