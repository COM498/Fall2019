<!DOCTYPE html>

<!--	(ﾉ◕ヮ◕)ﾉ*:･ﾟ✧   -->


  <head>
      <meta charset="utf-8">
      <meta http-equiv="X-UA-Compatible" content="IE=edge">
      <title>Scoreboard</title>
      <meta name="description" content="">
      <meta name="viewport" content="width=device-width, initial-scale=1">
      <link rel="stylesheet" href="./css styles/scoreboard.css">
  </head>
  
  <body>
    <table id="scoreboard" style="width:100%">
      <tr>
        <th>Team</th>
        <th>Level 1</th>
        <th>Level 2</th>
        <th>Level 3</th>
        <th>Level 4</th>
        <th>Level 5</th>
        <th>Number of Attempts</th>
        <th>Flags Solved</th>
        <th>Score</th>
      </tr>
    </table>

    <!--THIS IS THE NEW TABLE WE ARE TESTSING WITH THE ADDITION OF
    PROGRESS BARS TO SHOW HOW MANY QUESTIONS HAVE BEEN ANSWERED-->
    <table>
      <th>Name</th>
      <th>Status</th>
  
      <tr>
        <td>progress 1</td>
        <td>
            <div id="myProgress">
              <div id="myBar">(100%)</div>
            </div>
        </td>
      </tr>
  
      <tr>
        <td>progress 2</td>
        <td>
          <div id="myProgress2">
            <div id="myBar2">(60%)</div>
          </div>
        </td>
      </tr>
  
      <tr>
        <td>progress 3</td>
        <td>
          <div id="myProgress3">
            <div id="myBar3">(30%)</div>
          </div>
        </td>
      </tr>
  </table>
  <button id='m'>Activate Progress bar</button>
  <!--END OF THE CODE FOR THE TABLE TESTING-->





    <script type="text/javascript" src="./scripts/scoreboard_progress.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script type="text/javascript">
        $(document).ready(function() {

          const ajaxUrlEvents = "http://localhost:8080/api/currentevent";
          const ajaxUrlScore = "http://localhost:8080/api/scoreboard";

          var origDiv = document.getElementById("scoreboard");
          var count = origDiv.rows.length;
          var event;

          for (var i = 0; i < count; i++) {
              if (i > 0) {
                  var row = origDiv.rows[1];
                  var body = origDiv.childNodes[1];
                  body.removeChild(row);
              }
          }

          $.ajax({
            type: "GET",
            url: ajaxUrlEvents,
            async: false
          }).done(function(result) {
            if (result.recordset[0]["event_id"] != 0) {
              event = result.recordset[0]["event_id"];
              $.ajax({
                type: "POST",
                url: ajaxUrlScore,
                data: '{"EventID": "' + event + '"}',
                contentType: "application/json",
                async: false
              }).done(function(result) {
                if (result.recordset.length > 0) {
                  for (var i = 0; i < result.recordset.length; i++) {
                    var origDiv = document.getElementById("scoreboard");

                    var tr = origDiv.insertRow();
                    var td = tr.insertCell();
                    td.innerHTML = result.recordset[i]["team_name"];
                    td.id = "name" + result.recordset[i]["team_id"];

                    td = tr.insertCell();
                    td.innerHTML = result.recordset[i]["level1solved"] + " / " + result.recordset[i]["level1total"];
                    td.id = "level1" + result.recordset[i]["team_id"];

                    td = tr.insertCell();
                    td.innerHTML = result.recordset[i]["level2solved"] + " / " + result.recordset[i]["level2total"];
                    td.id = "level2" + result.recordset[i]["team_id"];

                    td = tr.insertCell();
                    td.innerHTML = result.recordset[i]["level3solved"] + " / " + result.recordset[i]["level3total"];
                    td.id = "level3" + result.recordset[i]["team_id"];

                    td = tr.insertCell();
                    td.innerHTML = result.recordset[i]["level4solved"] + " / " + result.recordset[i]["level4total"];
                    td.id = "level4" + result.recordset[i]["team_id"];

                    td = tr.insertCell();
                    td.innerHTML = result.recordset[i]["level5solved"] + " / " + result.recordset[i]["level5total"];
                    td.id = "level5" + result.recordset[i]["team_id"];

                    td = tr.insertCell();
                    td.innerHTML = result.recordset[i]["attempts"];
                    td.id = "attempts" + result.recordset[i]["team_id"];

                    td = tr.insertCell();
                    td.innerHTML = result.recordset[i]["solved"];
                    td.id = "solved" + result.recordset[i]["team_id"];

                    td = tr.insertCell();
                    td.innerHTML = result.recordset[i]["current_score"];
                    td.id = "score" + result.recordset[i]["team_id"];
                  }
                }
              });
            }
          });

          (function poll(){
          setTimeout(function(){
            $.ajax({
                type: "POST",
                url: ajaxUrlScore,
                data: '{"EventID": "' + event + '"}',
                contentType: "application/json",
                async: false
              }).done(function(result) {
                if (result.recordset.length > 0) {

                  var origDiv = document.getElementById("scoreboard");
                  var count = origDiv.rows.length;

                  for (var i = 0; i < count; i++) {
                    if (i > 0) {
                        var row = origDiv.rows[1];
                        var body = origDiv.childNodes[1];
                        body.removeChild(row);
                    }
                  }

                  for (var i = 0; i < result.recordset.length; i++) {

                    var origDiv = document.getElementById("scoreboard");

                    var tr = origDiv.insertRow();
                    var td = tr.insertCell();
                    td.innerHTML = result.recordset[i]["team_name"];
                    td.id = "name" + result.recordset[i]["team_id"];

                    td = tr.insertCell();
                    td.innerHTML = result.recordset[i]["level1solved"] + " / " + result.recordset[i]["level1total"];
                    td.id = "level1" + result.recordset[i]["team_id"];

                    td = tr.insertCell();
                    td.innerHTML = result.recordset[i]["level2solved"] + " / " + result.recordset[i]["level2total"];
                    td.id = "level2" + result.recordset[i]["team_id"];

                    td = tr.insertCell();
                    td.innerHTML = result.recordset[i]["level3solved"] + " / " + result.recordset[i]["level3total"];
                    td.id = "level3" + result.recordset[i]["team_id"];

                    td = tr.insertCell();
                    td.innerHTML = result.recordset[i]["level4solved"] + " / " + result.recordset[i]["level4total"];
                    td.id = "level4" + result.recordset[i]["team_id"];

                    td = tr.insertCell();
                    td.innerHTML = result.recordset[i]["level5solved"] + " / " + result.recordset[i]["level5total"];
                    td.id = "level5" + result.recordset[i]["team_id"];

                    td = tr.insertCell();
                    td.innerHTML = result.recordset[i]["attempts"];
                    td.id = "attempts" + result.recordset[i]["team_id"];

                    td = tr.insertCell();
                    td.innerHTML = result.recordset[i]["solved"];
                    td.id = "solved" + result.recordset[i]["team_id"];

                    td = tr.insertCell();
                    td.innerHTML = result.recordset[i]["current_score"];
                    td.id = "score" + result.recordset[i]["team_id"];
                  }
                }

                poll();
              });
          }, 30000);
          })();
        }); 
    </script>
  </body>
</html>